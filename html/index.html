<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>neos sessions</title>
        <style>
            body { margin: 0; color: white; background-color: black; }
            div#contents { display: flex; flex-wrap: wrap; }
            .alt { background-color: #333333;}
        </style>
        <link rel="stylesheet" href="css/sessionIcon.css">
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r127/three.min.js"></script> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r127/three.js"></script>
        <script src="js/neos_common.js"></script>
        <script src="js/panorama.js"></script>
        <script src="js/sessionIcon.js"></script>
    </head>
    <body>
        <div id="contents"></div>
        <script>
            const contents = document.getElementById("contents");
            const alt = document.createElement("div");
            alt.classList.add("alt");
            var sessionIcons = [];
            var panoramaLoads = [];
            var panoramaLoadCount = 0;
            var panoramaLoadRTT = 0;
            var panoramaLoader = () => {
                if(panoramaLoads.length > 0){
                    if(panoramaLoadCount <= 4){
                        const current = panoramaLoads.shift()
                        panoramaLoadCount++;
                        current.panorama_load().then(
                            () => {
                                panoramaLoadCount--;
                                panoramaLoadRTT = 0;
                            }
                        ).catch((err)=>{
                            if(panoramaLoadRTT < 6){
                                panoramaLoads.unshift(current);
                                panoramaLoadRTT++;
                            }else{
                                panoramaLoadCount--;
                                panoramaLoadRTT = 0;
                            }
                        });
                    }else if(PanoramaPreview.ActiveWebGLClasses < 2){
                        panoramaLoadCount = 0;
                    }
                }
                requestAnimationFrame(panoramaLoader);
            };
            panoramaLoader();
            const io = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if(entry.isIntersecting) {
                        entry.target.load();
                    }
                });
            },{
            rootMargin: "512px",
            });

            fetch('/sessions.json')
                .then((response) => response.json())
                .then((data) => {
                    data.forEach(e => {
                        const sessionIcon = new SessionIcon(contents, e, alt);
                        io.observe(sessionIcon.domElement);
                        sessionIcon.domElement.addEventListener("click", () => {
                            console.log(e);
                        });
                        sessionIcon.domElement.load = () => {
                            panoramaLoads.push(sessionIcon);
                        };
                    });
                });
            
        </script>
    </body>
</html>